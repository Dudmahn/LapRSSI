elapsedMillis beat;
IntervalTimer myTimer;
int heartbeat = 1;
float timer_value = 1;
float timer_save[8];
int pilot_rssi[8];
int rssi_threshold[8] = {550,550,550,550,550,550,550,550};
int pin[8] = {0,1,2,3,4,5,6,7};
char pilot_number[8] = {'0001','0002','0003','0004','0005','0006','0007','0008'};
int pilot;
int pilot_frequency[8];
int pilot_rssi_threshold[8];
int pilot_lap_step = 0;
int timer_trip = 0;

void setup()
{
  Serial.begin(9600); //opens serial port, sets data rate to 9600 bps
  myTimer.begin(timer, 1000);  // increment timer every 0.001 seconds
}

void timer(void)
{
  timer_value = timer_value + 0.001;
  for (int i = 0; i < 8; i++)
  {
    if (timer_save[i] == 0)
    {
      pilot_rssi[i] = analogRead(pin[i]);
      if (pilot_rssi[i] > rssi_threshold[i]) 
      {
        timer_save[i] = timer_value;
        timer_trip = 1;
      }
    }
  }
}

void loop()
{
  for (int i = 0; i < 8; i++)
  {
    if (beat >= 1000)
    {
      if  (timer_save[i] == 0)
      {
        Serial.print(" #");
        Serial.print("\t"); 
        Serial.print(heartbeat);
        Serial.print("\t");
        Serial.print(timer_value);
        Serial.print("\t");
        Serial.println("LapRSSI");
        heartbeat = heartbeat + 1;
       }
      else
      {
        noInterrupts();
        Serial.print(" @");
        Serial.print("\t");
        Serial.print(heartbeat);
        Serial.print("\t");
        Serial.print(pilot_number[i]);
        Serial.print("\t");
        Serial.print(timer_save[i], 3);
        Serial.print("\t");
        Serial.print(pilot_rssi[i]);
        Serial.print("\t");
        Serial.println("LapRSSI");
        interrupts();
        heartbeat = heartbeat + 1;
        timer_save[pilot_lap_step] = 0;
        timer_trip = 0;
      }
    }
    beat = 0;
  }
  if (Serial.available() > 0) 
  {
    if (Serial.peek() == '@') 
    {
      Serial.read();
      pilot = Serial.parseInt();
      for  (int i = 0; i < 8; i++)
      {
        if (pilot == i + 1)
        {
          pilot_frequency[i] = Serial.parseInt();
          pilot_rssi_threshold[i] = Serial.parseInt();
        }
      }
    }
  }
  while (Serial.available() > 0) 
  {
    Serial.read();
  }
}
